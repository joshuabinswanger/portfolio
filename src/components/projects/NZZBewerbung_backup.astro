---
import { CldImage } from "astro-cloudinary";
import { getCollection } from "astro:content";
const galleryImages = await getCollection("galleryImages");
---

<div id="scrolly-container">
  <!-- Intro Panel -->
  <div id="intro-panel" class="scrolly-panel">
    <h1 id="intro-head">Liebes NZZ Visuals Team,</h1>
    <h1 id="intro-name">ich heisse Joshua Binswanger</h1>
    <h1 id="intro-title">Scientific Illustrator & Visual Storyteller.</h1>
    <p id="intro-intersection">
      Ich bewege mich an der Schnittstelle von visuellem Design und Technologie.
    </p>
  </div>

  <!-- Work Panel -->
  <div id="work-panel" class="scrolly-panel">
    <p id="work-head">
      Seit meinem Abschluss in Knowledge Visualization an der ZHdK, arbeite ich
      als freischaffender wissenschaftlicher Illustrator.
    </p>

    <div class="work-content">
      <p id="work-scientific-illustration">
        Dabei vermittle ich wissenschaftliche Forschung
      </p>

      <!-- Stacking Image Container -->
      <div id="image-stack-container">
        <div id="img-phenological-shift-1" class="stacked-image">
          <CldImage
            src="Phenological_Shift_GalleryImage_2_rvbeeb"
            width="800"
            height="600"
            alt="Phenological Shift"
          />
        </div>

        <div id="img-living-bricks-1" class="stacked-image">
          <CldImage
            src="ETHVisualisations_Gallery_2_lqhc5s"
            width="800"
            height="600"
            alt="ETH Visualisations"
          />
        </div>

        <div id="img-bacteria" class="stacked-image">
          <CldImage
            src="ETH_CelluloseLivingMaterial_2_ttlmvt"
            width="800"
            height="600"
            alt="ETH Visualisations"
          />
        </div>

        <div id="img-fungi" class="stacked-image">
          <CldImage
            src="ETHVisualisations_Gallery_4_mcdinf"
            width="800"
            height="600"
            alt="ETH Visualisations"
          />
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import Lenis from "lenis";
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  // 1. Initialize Lenis
  const lenis = new Lenis({
    lerp: 0.1,
    wheelMultiplier: 1,
    smoothWheel: true,
  });

  lenis.on("scroll", ScrollTrigger.update);

  gsap.ticker.add((time) => {
    lenis.raf(time * 1000);
  });

  // 2. Master Timeline
  const masterTl = gsap.timeline({
    scrollTrigger: {
      trigger: "#scrolly-container",
      start: "top top",
      end: "+=700%", // Increased distance for more steps
      scrub: 1,
      pin: true,
      markers: false,
    },
  });

  // 3. Intro Timeline
  const introTl = gsap.timeline();
  introTl
    .to("#intro-head", { opacity: 1, y: -10, duration: 1 })
    .to("#intro-name", { opacity: 1, y: -10, duration: 1 })
    .to("#intro-title", { opacity: 1, y: -10, duration: 1 }, "+=0.5")
    .to("#intro-intersection", { opacity: 1, y: -10, duration: 1 }, "-=0.5")
    .to("#intro-panel", { opacity: 0, y: -50, duration: 2 }, "+=1");

  // 4. Work Timeline (with Sliding Images)
  const workTl = gsap.timeline();
  workTl
    .set("#work-panel", { opacity: 1 })
    .to("#work-head", { opacity: 1, y: -10, duration: 1 })
    .to("#work-scientific-illustration", { opacity: 1, y: -10, duration: 1 })
    // Image 1 fades and slides in
    .to(
      "#img-phenological-shift-1",
      { opacity: 1, y: 0, duration: 1.5 },
      "-=0.5",
    )
    // Image 2 slides OVER Image 1 (starts from y: 100% in CSS)
    .to("#img-living-bricks-1", { y: "0%", duration: 2 }, "+=0.5")
    .to("#img-bacteria", { y: "0%", duration: 2 }, "+=0.5")
    .to("#img-fungi", { y: "0%", duration: 2 }, "+=0.5")
    .to("#work-panel", { duration: 1, opacity: 0 });

  masterTl.add(introTl).add(workTl);
</script>

<style>
  @import "../../styles/global.css";

  #scrolly-container {
    position: relative;
    width: 100%;
    height: 100svh;
    overflow: hidden;
  }

  #scrolly-container p,
  #scrolly-container h1 {
    padding: 0 2rem;
  }

  h1 {
    font-size: 20px;
    padding-bottom: 2rem;
  }

  .scrolly-panel {
    position: absolute;
    top: 10%;
    width: 100%;
    display: flex;
    flex-direction: column;
  }

  /* Image Stacking Logic */
  #image-stack-container {
    position: relative;
    width: 100%;
    max-width: 800px;
    aspect-ratio: 4/3;
    margin: 2rem auto;
    overflow: hidden; /* Important so image 2 stays hidden below */
    border-radius: 8px;
  }

  .stacked-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    padding: 0 !important; /* Remove typography padding from images */
  }

  .stacked-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* INITIAL STATES */
  #work-panel {
    opacity: 0;
  }

  #intro-head,
  #intro-name,
  #intro-title,
  #intro-intersection,
  #work-head,
  #work-scientific-illustration {
    opacity: 0;
    transform: translateY(10px);
  }

  #img-phenological-shift-1 {
    opacity: 0;
    transform: translateY(20px);
  }

  #img-living-bricks-1 {
    /* Positioned fully below the container, ready to slide up */
    transform: translateY(100%);
    z-index: 2;
  }

  #img-bacteria {
    transform: translateY(100%);
    z-index: 3;
  }

  #img-fungi {
    transform: translateY(100%);
    z-index: 4;
  }
</style>
