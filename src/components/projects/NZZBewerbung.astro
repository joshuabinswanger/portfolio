---
import { CldImage } from "astro-cloudinary";
import { getCollection } from "astro:content";
const galleryImages = await getCollection("galleryImages");
---

<div id="scrolly-container">
  <div id="panel-1" class="scrolly-panel center-panel">
    <div class="text-container">
      <h1 class="text-block t-1-1">Hallo, <br />ich bin Joshua Binswanger.</h1>
      <h2 class="text-block t-1-2">
        Als wissenschaftlicher Illustrator bewege ich mich genau an der
        Schnittstelle von Design und Technologie.
      </h2>
    </div>
  </div>

  <div id="panel-2" class="scrolly-panel split-panel">
    <div class="text-col">
      <p class="text-block t-2-1">
        Seit meinem Abschluss in Knowledge Visualization an der ZHdK arbeite ich
        freischaffend.
      </p>
      <p class="text-block t-2-2">
        Mein Ziel: komplexe Sachverhalte und Daten nicht nur präzise abzubilden,
      </p>
      <p class="text-block t-2-3">
        sondern visuell so aufzubereiten, dass sie für ein breites Publikum
        greifbar werden.
      </p>
    </div>
    <div class="img-col">
      <div class="img-stack i-2-1">
        <CldImage
          src="Phenological_Shift_GalleryImage_2_rvbeeb"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="Phenological Shift"
        />
      </div>
      <div class="img-stack i-2-2">
        <CldImage
          src="ETHVisualisations_Gallery_2_lqhc5s"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="ETH Visualisations"
        />
      </div>
      <div class="img-stack i-2-3">
        <CldImage
          src="ETHVisualisations_Gallery_4_mcdinf"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="ETH Visualisations"
        />
      </div>
      <div class="img-stack i-2-4">
        <CldImage
          src="Microbiome_OLMA_ttmkmz"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="Microbiome"
        />
      </div>
      <div class="img-stack i-2-5">
        <CldImage
          src="Microbiome_GalleryImages_3_tej0fp"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="Microbiome"
        />
      </div>
      <div class="img-stack i-2-6">
        <CldImage
          src="Freedom_GalleryImages_5_pbxr8g"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="Freedom Gallery"
        />
      </div>
      <div class="img-stack i-2-7">
        <CldImage
          src="Freedom_Infografik_z43mem"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="Freedom Infographic"
        />
      </div>
    </div>
  </div>

  <div id="panel-3" class="scrolly-panel split-panel">
    <div class="text-col">
      <p class="text-block t-3-1">
        Mein wichtigstes Werkzeug dafür ist 3D – ob als hochauflösendes Still,
      </p>
      <p class="text-block t-3-2">
        als Animation oder für interaktive Web-Formate.
      </p>
      <p class="text-block t-3-3">
        Das Fundament meiner Arbeit bleibt jedoch das Handwerk: Zeichnen und
        Illustration bilden die Basis für gutes Design.
      </p>
    </div>
    <div class="img-col">
      <div class="img-stack i-3-1">
        <CldImage
          src="StructureofWood_Gallery_5_g1x7ry"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="Structure of Wood"
        />
      </div>
      <div class="img-stack i-3-2">
        <CldImage
          src="StructureofWood_Gallery_4_llpwgf"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="Structure of Wood"
        />
      </div>
      <div class="img-stack i-3-3">
        <CldImage
          src="ETHVisualisations_Gallery_3_myrndw"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="ETH Visualisations"
        />
      </div>
      <div class="img-stack i-3-4">
        <CldImage
          src="ETHVisualisations_Gallery_1_skyq6j"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="ETH Visualisations"
        />
      </div>
      <div class="img-stack i-3-5">
        <CldImage
          src="N64_avif_sequence"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="N64 Sequence"
        />
      </div>
      <div class="img-stack i-3-6">
        <CldImage
          src="Xylopedia_Ipad_topget"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="Xylopedia iPad"
        />
      </div>
      <div class="img-stack i-3-7">
        <CldImage
          src="Xylopedia_Gallery_1_afnq0i"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="Xylopedia"
        />
      </div>
      <div class="img-stack i-3-8">
        <CldImage
          src="Illustration_GalleryImages_1_sihglc"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="Illustration"
        />
      </div>
      <div class="img-stack i-3-9">
        <CldImage
          src="Illustration_GalleryImages_6_wgojna"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="Illustration"
        />
      </div>
      <div class="img-stack i-3-10">
        <CldImage
          src="Borkenkaefer_Gallery_1_daro6y"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="Borkenkäfer"
        />
      </div>
      <div class="img-stack i-3-11">
        <CldImage
          src="FigureDrawing_Gallery_23_dnrpi3"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="Figure Drawing"
        />
      </div>
    </div>
  </div>

  <div id="panel-4" class="scrolly-panel center-panel">
    <div class="text-container">
      <p class="text-block t-4-1">
        Um meine Arbeitsprozesse effizienter zu gestalten, erweitere ich mein
        technisches Know-how stetig.
      </p>
      <p class="text-block t-4-2">
        Bei der Augmedi AG entwickle ich aktuell 3D-Scans (Photogrammetry &
        Gaussian Splats) für ein Next-Gen-Anatomietool. Dabei nutze ich <em
          >Houdini</em
        > und <em>Python</em>, um Pipelines prozedural aufzubauen und zu
        automatisieren.<br /><br /><a href="#" class="inline-link"
          >Link zu Augmedi</a
        >
      </p>
      <p class="text-block t-4-3">
        Auch bemühe ich mich die neusten KI-Tools wie Weavy in meinen Workflow
        einzubauen, um den kreativen Prozesse zu beschleunigen.
      </p>
    </div>
  </div>

  <div id="panel-5" class="scrolly-panel split-panel">
    <div class="text-col">
      <p class="text-block t-5-1">
        Visual Storytelling und Lerntools entfalten ihre grösste Kraft im
        digitalen Raum. Viele meiner Projekte bewegen sich an der Schittstelle
        zum Web,
      </p>
      <p class="text-block t-5-2">
        deshalb habe ich mir die Grundlagen des Web Designs angeeignet. Mein
        grösstes Projekt war mein persönliches Portfolio.<br /><br /><a
          href="https://rhizome.ch"
          target="_blank"
          class="inline-link"
          >Für einen tieferen Einblick in meine Arbeit besuchen sie rhizome.ch</a
        >
      </p>
    </div>
    <div class="img-col">
      <div class="img-stack i-5-1">
        <CldImage
          src="UBJahresbericht"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="UB Jahresbericht"
        />
      </div>
      <div class="img-stack i-5-2">
        <CldImage
          src="Portfolio"
          width="1200"
          sizes="(max-width: 768px) 100vw, 50vw"
          alt="Portfolio"
        />
      </div>
    </div>
  </div>

  <div id="panel-6" class="scrolly-panel center-panel">
    <div class="text-container">
      <h2 class="text-block t-6-1">
        Seit langem verfolge ich die Arbeit des NZZ Visuals Teams – eure
        analytische Tiefe und optische Eleganz beeindrucken mich sehr.
      </h2>
      <p class="text-block t-6-2">
        Ich bin es gewohnt, komplexe Inhalte analytisch zu durchdringen.
        Kombiniert mit meinem breiten Skillset in Design, 3D und Code bringe ich
        das perfekte Rüstzeug mit.
      </p>
      <h2 class="text-block t-6-3">
        Ich bewerbe mich für das Volontariat, weil ich mir keinen besseren Ort
        vorstellen kann, um meine Fähigkeiten auf weiterzuentwickeln und
        gemeinsam mit Ihnen neue visuelle Formate zu prägen.
      </h2>
    </div>
  </div>

  <div id="panel-7" class="scrolly-panel center-panel">
    <div class="text-container">
      <h1 class="text-block t-7-1">Vielen Dank für Ihre Zeit.</h1>
      <h2 class="text-block t-7-2">
        Ich freue mich auf ein persönliches Gespräch.
      </h2>
      <div class="text-block t-7-3 action-links">
        <a href="mailto:hallo@rhizome.ch" class="btn">E-Mail schreiben</a>
        <a href="/cv.pdf" target="_blank" class="btn">CV herunterladen</a>
      </div>
    </div>
  </div>
</div>

<script>
  import Lenis from "lenis";
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";
  import { CustomEase } from "gsap/CustomEase";

  gsap.registerPlugin(ScrollTrigger, CustomEase);

  // 1. Initialize Lenis
  const lenis = new Lenis({
    lerp: 0.1,
    wheelMultiplier: 1,
    smoothWheel: true,
  });

  lenis.on("scroll", ScrollTrigger.update);

  gsap.ticker.add((time) => {
    lenis.raf(time * 1000);
  });

  // 2. Master Timeline - increased duration significantly for the volume of content
  const masterTl = gsap.timeline({
    scrollTrigger: {
      trigger: "#scrolly-container",
      start: "top top",
      end: "+=15000%", // Provides enough scrolling length for smooth reading
      scrub: 1,
      pin: true,
      markers: false,
    },
  });

  // Helper Functions to keep the timeline clean
  const showText = (selector, sync = false) => {
    return masterTl.to(
      selector,
      { opacity: 1, y: 0, duration: 1 },
      sync ? "<" : "+=0.2",
    );
  };
  const hideText = (selector, sync = false) => {
    return masterTl.to(
      selector,
      { opacity: 0, y: -20, duration: 1 },
      sync ? "<" : "+=0.2",
    );
  };

  const showImg = (selector, sync = false) => {
    // Create a localized mini-timeline for this specific image
    const imageTl = gsap.timeline();

    imageTl
      .to(selector, {
        y: "-15%",
        duration: 1,
      })
      .to(
        selector,
        {
          opacity: 1,
          duration: 0.8,
        },
        ">-0.8",
      ); // Starts 0.2s before the 1s movement ends

    // Add the mini-timeline to your masterTl
    return masterTl.add(imageTl, sync ? "<" : "+=0.2");
  };

  const hideImg = (selector, sync = false) => {
    return masterTl.to(
      selector,
      {
        y: "-100%",
        opacity: 0,
        duration: 1,
      },
      sync ? "<" : "+=0.2",
    );
  };
  const pause = (duration = 0.5) => {
    return masterTl.to({}, { duration: duration });
  };

  // --- PANEL 1: Intro ---
  masterTl.set("#panel-1", { opacity: 1 });
  showText(".t-1-1");
  showText(".t-1-2");
  pause(1);
  masterTl.to("#panel-1", { opacity: 0, duration: 1 });

  // --- PANEL 2: Mission ---
  masterTl.to("#panel-2", { opacity: 1, duration: 1 });

  showText(".t-2-1");
  showImg(".i-2-1", true);
  pause();
  hideImg(".i-2-1");
  showImg(".i-2-2");
  pause();
  hideImg(".i-2-2");
  showImg(".i-2-3");
  pause();
  hideText(".t-2-1");
  hideImg(".i-2-3");

  showText(".t-2-2", true);
  showImg(".i-2-4", true);
  pause();
  hideImg(".i-2-4");
  showImg(".i-2-5");
  pause();
  hideText(".t-2-2");
  hideImg(".i-2-5");

  showText(".t-2-3", true);
  showImg(".i-2-6", true);
  pause();
  hideImg(".i-2-6");
  showImg(".i-2-7");
  pause(1);

  hideImg(".i-2-7");
  masterTl.to("#panel-2", { opacity: 0, duration: 1 }, "<");

  // --- PANEL 3: Werkzeuge ---
  masterTl.to("#panel-3", { opacity: 1, duration: 1 });

  showText(".t-3-1");
  showImg(".i-3-1", true);
  pause();
  hideImg(".i-3-1");
  showImg(".i-3-2");
  pause();
  hideImg(".i-3-2");
  showImg(".i-3-3");
  pause();
  hideImg(".i-3-3");
  showImg(".i-3-4");
  pause();
  hideText(".t-3-1");
  hideImg(".i-3-4");

  showText(".t-3-2", true);
  showImg(".i-3-5", true);
  pause();
  hideImg(".i-3-5");
  showImg(".i-3-6");
  pause();
  hideImg(".i-3-6");
  showImg(".i-3-7");
  pause();
  hideText(".t-3-2");
  hideImg(".i-3-7");

  showText(".t-3-3", true);
  showImg(".i-3-8", true);
  pause();
  hideImg(".i-3-8");
  showImg(".i-3-9");
  pause();
  hideImg(".i-3-9");
  showImg(".i-3-10");
  pause();
  hideImg(".i-3-10");
  showImg(".i-3-11");
  pause(1);

  hideImg(".i-3-11");
  masterTl.to("#panel-3", { opacity: 0, duration: 1 }, "<");

  // --- PANEL 4: Tech ---
  masterTl.to("#panel-4", { opacity: 1, duration: 1 });
  showText(".t-4-1");
  showText(".t-4-2");
  showText(".t-4-3");
  pause(1);
  masterTl.to("#panel-4", { opacity: 0, duration: 1 });

  // --- PANEL 5: Web ---
  masterTl.to("#panel-5", { opacity: 1, duration: 1 });

  showText(".t-5-1");
  showImg(".i-5-1", true);
  pause();
  hideText(".t-5-1");
  hideImg(".i-5-1");

  showText(".t-5-2", true);
  showImg(".i-5-2", true);
  pause(1);

  hideImg(".i-5-2");
  masterTl.to("#panel-5", { opacity: 0, duration: 1 }, "<");

  // --- PANEL 6: Pitch ---
  masterTl.to("#panel-6", { opacity: 1, duration: 1 });
  showText(".t-6-1");
  showText(".t-6-2");
  showText(".t-6-3");
  pause(1.5);
  masterTl.to("#panel-6", { opacity: 0, duration: 1 });

  // --- PANEL 7: Outro ---
  masterTl.to("#panel-7", { opacity: 1, duration: 1 });
  showText(".t-7-1");
  showText(".t-7-2");
  showText(".t-7-3");
  // Holds on the final frame due to end of timeline
</script>

<style>
  @import "../../styles/global.css";

  #scrolly-container {
    position: relative;
    width: 100%;
    height: 100svh;
    overflow: hidden;
  }

  .scrolly-panel {
    position: absolute;
    inset: 0;
    opacity: 0; /* Hidden by default */
  }

  /* --- Panel Types (Mobile First) --- */

  .center-panel {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 5%;
  }

  .split-panel {
    height: 100svh;
    box-sizing: border-box;
  }

  .text-col {
    position: absolute;
    width: 100%;
    height: 100svh; /* Top 1/4 of the viewport */
    background-color: transparent;
  }

  .img-col {
    position: absolute;
    width: 100%;
    height: 100svh; /* Lower 2/4 (Half the screen) */
    overflow: hidden;
    margin: 0 auto;
  }

  /* --- Typography --- */

  .text-container {
    max-width: 800px;
    text-align: left;
  }

  .text-block {
    opacity: 0;
    z-index: 2;
    transform: translateY(20px); /* Pre-set for animation */
    line-height: 1.5;
  }

  .center-panel .text-block {
    margin-bottom: 2rem;
  }

  .text-col .text-block {
    position: absolute;
    justify-self: center;
    width: 90%;
    padding: 70vh 5% 0 5%;
    top: 0;
    left: 0;
    font-size: var(--font-size-mobile);
    margin: 0;
  }

  h1.text-block {
    font-size: 24px;
    font-weight: 700;
    line-height: 1.5;
    margin-bottom: 1.5rem;
  }

  h2.text-block {
    font-size: var(--font-size-mobile-h1);
    font-weight: 400;
  }

  p.text-block {
    font-size: var(--font-size-mobile);
  }

  /* --- Image Stacking --- */

  .img-stack {
    position: absolute;
    inset: 0;
    opacity: 0;
    padding: 0 5%;
    transform: translateY(100%);
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none; /* Allows clicking through hidden images */
  }

  .img-stack img {
    width: 100%; /* Take up full container width */
    height: auto; /* Maintain aspect ratio */
    max-width: 800px; /* Optional: cap the size so it doesn't get too huge */
    max-height: 60vh; /* Keep it within the viewport height */
    object-fit: scale-down !important;
  }

  /* --- Links and Buttons --- */

  .inline-link {
    color: #1a1a1a;
    text-decoration: underline;
    text-decoration-thickness: 1px;
    text-underline-offset: 4px;
    transition: opacity 0.3s;
  }

  .inline-link:hover {
    opacity: 0.7;
  }

  .action-links {
    margin-top: 3rem;
    display: flex;
    gap: 1.5rem;
    justify-content: center;
  }

  .btn {
    display: inline-block;
    padding: 0.8rem 1.5rem;
    border: 1px solid #1a1a1a;
    border-radius: 4px;
    color: #1a1a1a;
    text-decoration: none;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all 0.3s ease;
  }

  /* Desktop Responsiveness */
  @media (min-width: 768px) {
    .split-panel {
      flex-direction: row;
      align-items: center;
      justify-content: center;
      padding: 0 5%;
      gap: 4rem;
    }

    .text-col {
      height: 50vh;
      width: 50%;
    }

    .text-col .text-block {
      top: 20%; /* Vertically balance text block on desktop */
    }

    .img-col {
      height: 100vh;
      width: 50%;
      display: flex;
      align-items: center;
      position: relative;
    }

    h1.text-block {
      font-size: 3rem;
    }
    h2.text-block {
      font-size: 2rem;
    }
    p.text-block {
      font-size: 1.25rem;
    }
  }
</style>
